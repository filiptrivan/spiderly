# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET CLI Test

on:
  workflow_dispatch : #manual trigger on deployment


jobs:
  build:

    runs-on: windows-latest


    steps:
     - name: Checkout repository
       uses: actions/checkout@v3

      # Setup .NET
     - name: Setup .NET
       uses: actions/setup-dotnet@v3
       with:
        dotnet-version: '9.0.x'

     - name: Restore .NET dependencies
       run: dotnet restore Spiderly.CLI/Spiderly.CLI.csproj

     - name: Build .NET project
       run: |
         dotnet build Spiderly.CLI/Spiderly.CLI.csproj
     - name: Install SQL Server Express
       shell: powershell
       run: |
        Write-Host "Shell Path: $PSVersionTable"

        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
          Write-Host "Chocolatey not found - installing..."
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        } else {
          Write-Host "Chocolatey found"
        }

        choco --version

        choco install sql-server-express -y

        Start-Service MSSQL`$SQLEXPRESS
        Write-Host "SQL Server Express installation complete."


     - name: Start SQL Server Express
       run: |
          Start-Service MSSQL`$SQLEXPRESS
       shell: powershell
      
     - name: Pack, install, and run Spiderly CLI with inputs
       shell: powershell
       run: |
          try {
            dotnet tool uninstall --global Spiderly.CLI
          } catch {
            Write-Host "Tool not installed, skipping uninstall."
          }

          dotnet pack Spiderly.CLI/Spiderly.CLI.csproj -o ./nupkg

          dotnet tool install --global Spiderly.CLI --add-source ./nupkg

          # Add dotnet global tools to PATH in this session
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

          $inputs = @(
            "test"
            "default"
          ) -join "`r`n"

          $inputs | spiderly init
